{% extends 'forum.base' %}



{% block title %}{{ topic.subject ~ (paginate.currentPage() > 1 ? (' - Strona ' ~ paginate.currentPage())) }}{{ parent() }}{% endblock %}
{% block description %}{{ excerpt(posts[0].text, 100) }}{% endblock %}

{% import 'components.forms' as forms %}
{% import 'components.modals' as modals %}

{% set is_locked = topic.is_locked or forum.is_locked %}

{% block content %}

  {% if topic.locked_at %}
    <p class="alert alert-warning">
      Wątek zablokowany {{ topic.locked_at|format_date }} przez <a class="alert-warning" href="{{ route('profile', [topic.locker.id]) }}">{{ topic.locker.name }}</a>.
    </p>
  {% endif %}

  {% if topic.moved_at %}
    <p class="alert alert-warning">
      Wątek przeniesiony {{ topic.moved_at|format_date }} z
      <a class="alert-link" href="{{ route('forum.category', [topic.prevForum.slug]) }}">{{ topic.prevForum.name }}</a> przez
      <a class="alert-link" href="{{ route('profile', [topic.mover.id]) }}">{{ topic.mover.name }}</a>.
    </p>
  {% endif %}

  {% if errors.first('_token') %}
    <p class="alert alert-danger">
      {{ errors.first('_token') }}
    </p>
  {% endif %}

  <h1 class="mb-0">{{ link_to_route('forum.topic', topic.subject, [forum.slug, topic.id, topic.slug]) }}</h1>

  {% include "forum.partials.top" %}

  <main id="js-post" class="mainbar">
    <div class="row no-gutters mb-3">
      <div class="mr-auto">
        {{ paginate|raw }}
      </div>

      {% if not is_locked or is_writeable %}
        <div class="ml-auto">
          <a href="{{ route('forum.topic.submit', [forum.slug]) }}" class="btn btn-primary btn-sm">Nowy wątek</a>
          <a href="{{ route('forum.post.submit', [forum.slug, topic.id]) }}" class="btn btn-primary btn-sm ml-2">Odpowiedz</a>
        </div>
      {% endif %}
    </div>

    <vue-post
      v-for="post in posts"
      :key="post.id"
      :post="post"
    ></vue-post>

    <div class="row no-gutters mb-3">
      <div class="mr-auto">
        {{ paginate|raw }}
      </div>

      <div class="ml-auto">
        {% if not is_locked or is_writeable %}
          <a href="{{ route('forum.post.submit', [forum.slug, topic.id]) }}" class="btn btn-primary btn-sm float-right ml-3">Odpowiedz</a>
        {% endif %}
      </div>
    </div>

    {% if forumList is defined %}
      <div class="row no-gutters">
        <div class="ml-auto">
          {{ form_select('forum', forumList, forum.slug, {'id': 'sel-forum-list', 'class': 'form-control d-inline w-auto', 'data-url': route('forum.home')}) }}

          <a class="btn" href="javascript:" id="btn-goto">
            <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>
    {% endif %}

    {# todo: wyswietlamy tylko gdy mozna pisac w tym watku #}
    <vue-form></vue-form>

    <section class="row no-gutters mt-3">
      {% include 'forum.partials.per_page' with {label: 'Liczba odpowiedzi na stronę', perPage: paginate.perPage()} %}
    </section>

  {#    {% include 'forum.partials.poll' %}#}


    {{ viewers|raw }}


    {% if can('move', forum) %}
      <vue-modal ref="move-modal">
        <template v-slot:title>Czy chcesz przenieść?</template>

        <template v-slot:buttons>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
          <button type="submit" class="btn btn-danger danger">Tak, przenieś</button>
        </template>

        <p>Czy na pewno chcesz przenieść wątek do innej kategorii?</p>
        {{ form_select('reason', {0: '-- Wybierz --'} + reasonList, 0, {'class': 'form-control form-control-sm'}) }}

      </vue-modal>
    {% endif %}
  </main>

  {% embed 'forum.partials.sidebar' %}
    {% block side_menu %}
      <div id="js-sidebar" class="box" v-cloak>
        <ul class="side-menu mt-2">
          {% if auth_check() %}
            <li class="btn-watch {{ subscribers[user('id')] is defined ? 'on' }}">
              <a href="javascript:">
                <i class="far fa-star fa-fw"></i>
                <i class="fas fa-star fa-fw"></i>

                <span>
                    {% if subscribers[user('id')] is not defined %}
                      Obserwuj wątek
                    {% else %}
                      Zakończ obserwację
                    {% endif %}
                </span>

                {% if subscribers.count() > 0 %}
                  <small>({{ declination(subscribers.count(), ['obserwujący', 'obserwujących', 'obserwujących']) }})</small>
                {% endif %}
              </a>
            </li>
          {% endif %}

          {% if can('update', forum) %}
            <li>
              <a href="{{ route('forum.stream', [topic.id]) }}" title="Zobacz dziennik zdarzeń">
                <i class="fa fa-chart-pie fa-fw"></i>

                Dziennik zdarzeń
              </a>
            </li>

            <li>
              <a href="javascript:" title="Kliknij, aby szybko zmienić tytuł wątku">
                <i class="fa fa-pencil-alt fa-fw"></i>

                Zmień tytuł
              </a>
            </li>
          {% endif %}

          {% if can('lock', forum) %}
            <li>
              <a href="javascript:" @click="lock" title="Kliknij, aby zablokować wątek">
                <i v-if="!topic.is_locked" class="fa fa-lock fa-fw"></i>
                <i v-else class="fa fa-unlock fa-fw"></i>

                <span v-if="topic.is_locked">Odblokuj wątek</span>
                <span v-else>Zablokuj wątek</span>
              </a>
            </li>
          {% endif %}

          {% if can('move', forum) %}
            <li id="btn-move">
              <a title="Przenieść ten temat do innej kategorii forum" href="#collapse-sub" data-toggle="collapse">
                <i class="fa fa-arrow-circle-right fa-fw"></i>

                Przenieś wątek
              </a>

              <ul id="collapse-sub" class="collapse">
                {% for slug, name in adminForumList %}
                  {% if slug == forum.slug %}
                    <li><a style="color: #ccc">{{ name|raw }}</a></li>
                  {% else %}
                    <li><a data-slug="{{ slug }}" href="javascript:">{{ name|raw }}</a></li>
                  {% endif %}
                {% endfor %}
              </ul>
            </li>
          {% endif %}
        </ul>
      </div>
    {% endblock %}

    {% block related %}
      {% if mlt|length > 0 %}
        <section id="box-related" class="box related">
          <h4 class="border-bottom"><i class="far fa-eye fa-fw"></i> Strony pokrewne</h4>

          <div>
            <ul>
              {% for page in mlt %}
                <li>
                  <a data-category="forum-related" href="{{ route('forum.topic', [page.forum.slug, page.id, page.slug]) }}" title="{{ page.subject|raw }}">
                    <strong>{{ page.subject|raw }}</strong>
                    <small>{{ page.last_post_created_at|format_date }}</small>
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </section>
      {% endif %}
    {% endblock %}
  {% endembed %}

  {# Nie usuwac! Tutaj beda wyswietlane ewentualne bledy AJAX #}
  {{ modals.alert('Błąd', 'Błąd', 'alert') }}

  {% if auth_check() %}
    {{ modals.confirm('Komentarz zostanie usunięty. Czy na pewno chcesz to zrobić?', 'Czy chcesz usunąć?', 'modal-comment-delete') }}

    {{ form_open({'url': '#'}) }}
    <div class="modal fade" id="modal-post-delete" tabindex="-1" role="dialog" aria-labelledby="modal-post-delete" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Czy chcesz usunąć?</h4>
          </div>
          <div class="modal-body">
            <p>Post zostanie usunięty. Czy na pewno chcesz to zrobić?</p>

            {% if reasonList %}
              {{ form_select('reason', {0: '-- Wybierz --'} + reasonList, 0, {'class': 'form-control form-control-sm'}) }}
            {% endif %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
            <button type="submit" class="btn btn-danger danger" data-submit-state="Usuwanie...">Tak, usuń</button>
          </div>
        </div>
      </div>
    </div>
    {{ form_close() }}


    {{ modals.alert('Wystąpił błąd podczas działania programu.') }}
  {% endif %}

  {% if can('update', forum) %}
    {{ form_open({'url': route('forum.topic.subject', [topic.id])}) }}
    <div class="modal fade" id="modal-subject" tabindex="-1" role="dialog" aria-labelledby="modal-subject" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Zmień tytuł wątku</h4>
          </div>
          <div class="modal-body">
            {{ form_text('subject', topic.subject, {'class': 'form-control', 'required': 'required'}) }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
            <button type="submit" class="btn btn-danger danger" data-submit-state="Wysyłanie...">Zmień tytuł</button>
          </div>
        </div>
      </div>
    </div>
    {{ form_close() }}
  {% endif %}

  {% if can('merge', forum) %}
    {{ form_open({'url': '#'}) }}
    {{ modals.confirm('Czy chcesz połaczyć ten post z poprzednim?', 'Czy chcesz połączyć?', 'modal-merge', 'Tak, połącz') }}
    {{ form_close() }}
  {% endif %}
{% endblock %}

{% block body %}
  <script>
    var pagination = {{ posts|json_encode|raw }};
    var topic = {{ topic|json_encode|raw }};
  </script>

  {{ parent() }}


{#  <script type="text/javascript">#}
{#    $(function () {#}
{#      $('.col-bottom a').tooltip({'trigger': 'hover'});#}
{#      $('#submit-form').append('<input style="display: none" type="checkbox" name="human" value="1" checked="checked">');#}
{#    });#}
{#  </script>#}
{% endblock %}
