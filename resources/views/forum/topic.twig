{% extends 'forum.base' %}

{% block title %}{{ topic.subject ~ (paginate.currentPage() > 1 ? (' - Strona ' ~ paginate.currentPage())) }}{{ parent() }}{% endblock %}
{% block description %}{{ description }}{% endblock %}

{% import 'components.forms' as forms %}
{% import 'components.modals' as modals %}

{% block content %}

  {% if model.locked_at %}
    <p class="alert alert-warning">
      Wątek zablokowany {{ model.locked_at|format_date }} przez <a class="alert-warning" href="{{ route('profile', [model.locker.id]) }}">{{ model.locker.name }}</a>.
    </p>
  {% endif %}

  {% if model.moved_at %}
    <p class="alert alert-warning">
      Wątek przeniesiony {{ model.moved_at|format_date }} z
      <a class="alert-link" href="{{ route('forum.category', [model.prevForum.slug]) }}">{{ model.prevForum.name }}</a> przez
      <a class="alert-link" href="{{ route('profile', [model.mover.id]) }}">{{ model.mover.name }}</a>.
    </p>
  {% endif %}

  {% if errors.first('_token') %}
    <p class="alert alert-danger">
      {{ errors.first('_token') }}
    </p>
  {% endif %}

  <h1 class="mb-0">{{ link_to_route('forum.topic', topic.subject, [forum.slug, topic.id, topic.slug]) }}</h1>

  {% include "forum.partials.top" %}

  <main id="js-post" class="mainbar">
    <div class="row no-gutters mb-3">
      <div class="mr-auto">
        {{ paginate|raw }}
      </div>

      {% if is_writeable %}
        <div class="ml-auto">
          <a href="{{ route('forum.topic.submit', [forum.slug]) }}" class="btn btn-primary btn-sm">Nowy wątek</a>
          <a href="#js-submit-form" class="btn btn-primary btn-sm ml-2">Odpowiedz</a>
        </div>
      {% endif %}
    </div>

    {% for i in 0..4 %}
      <div v-if="skeleton" class="card card-post">
        <div class="card-header">
          <div class="row d-none d-lg-flex">
            <div class="col-2">
              <div class="skeleton" style="height: 20px"></div>
            </div>

            <div class="col-10 text-truncate small">
              <div class="skeleton" style="height: 20px; width: 30%"></div>
            </div>
          </div>
        </div>

        <div class="card-body">
          <div class="media d-lg-none mb-2">
            <div class="media-left mr-2">
              <div class="skeleton" style="width: 35px; height: 35px"></div>
            </div>

            <div class="media-body">
              <div class="skeleton" style="height: 20px"></div>
            </div>
          </div>

          <div class="row">
            <div class="d-none d-lg-block col-lg-2">
              <div class="skeleton" style="width: 75px; height: 75px"></div>
            </div>

            <div class="col-12 col-lg-10">
              <div class="skeleton mb-1" style="height: 10px"></div>
              <div class="skeleton mb-1" style="height: 10px"></div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}

    <template v-if="'id' in poll">
      <vue-poll :poll="poll"></vue-poll>
    </template>

    <vue-post
      v-for="post in posts"
      :key="post.id"
      :post="post"
      :reasons="reasons"
      upload-mimes="{{ config_get('filesystems.upload_mimes')|split(',')|join(', ') }}"
      upload-max-size="{{ config_get('filesystems.upload_max_size') }}"
      @reply="reply"
    ></vue-post>

    <div class="row no-gutters mb-3">
      <div class="mr-auto">
        {{ paginate|raw }}
      </div>

      <div class="ml-auto">
        {% if is_writeable %}
          <a href="#js-submit-form" class="btn btn-primary btn-sm float-right ml-3">Odpowiedz</a>
        {% endif %}
      </div>
    </div>

    {% if user_forums is defined %}
      <div class="row no-gutters">
        <div class="ml-auto">
          {{ form_select('forum', user_forums, forum.slug, {'id': 'js-forum-list', 'class': 'form-control d-inline w-auto', 'data-url': route('forum.home')}) }}

          <a class="btn" href="javascript:" id="js-reload">
            <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>
    {% endif %}

    {% if is_writeable %}
      <vue-form
        id="js-submit-form"
        ref="js-submit-form"
        :post="undefinedPost"
        upload-mimes="{{ config_get('filesystems.upload_mimes')|split(',')|join(', ') }}"
        upload-max-size="{{ config_get('filesystems.upload_max_size') }}"
      ></vue-form>
    {% endif %}

    <section class="row no-gutters mt-3">
      {% include 'forum.partials.per_page' with {label: 'Liczba odpowiedzi na stronę', perPage: paginate.perPage()} %}
    </section>

    {{ viewers|raw }}

    <vue-notifications position="bottom right"/>
  </main>

  {% embed 'forum.partials.sidebar' %}
    {% block side_menu %}
      <div id="js-sidebar" class="box" v-cloak>
        <ul class="side-menu mt-2">
          <li v-if="isAuthorized" :class="{'on': topic.is_subscribed}" class="btn-subscribe">
            <a @click="subscribe(topic)" href="javascript:">
              <i :class="{'fas': topic.is_subscribed, 'far': !topic.is_subscribed}" class="fa-star fa-fw"></i>

              <span v-if="topic.is_subscribed">Zakończ obserwację</span>
              <span v-else>Obserwuj wątek</span>

              <small v-if="topic.subscribers">(${ topic.subscribers } ${ topic.subscribers | declination(['obserwujący', 'obserwujących', 'obserwujących']) })</small>
            </a>
          </li>

          {% if can('update', forum) %}
            <li>
              <a href="{{ route('forum.stream', [topic.id]) }}" title="Zobacz dziennik zdarzeń">
                <i class="fa fa-chart-pie fa-fw"></i>

                Dziennik zdarzeń
              </a>
            </li>

            <li>
              <a @click="$refs['update-modal'].open()" href="javascript:" title="Kliknij, aby szybko zmienić tytuł wątku">
                <i class="fa fa-pencil-alt fa-fw"></i>

                Zmień tytuł
              </a>
            </li>
          {% endif %}

          {% if can('lock', forum) %}
            <li>
              <a @click="lock" href="javascript:" title="Kliknij, aby zablokować wątek">
                <i :class="{'fa-lock': !topic.is_locked, 'fa-unlock': topic.is_locked}" class="fa fa-lock fa-fw"></i>

                <span v-if="topic.is_locked">Odblokuj wątek</span>
                <span v-else>Zablokuj wątek</span>
              </a>
            </li>
          {% endif %}

          {% if can('move', forum) %}
            <li>
              <a @click="$refs['forum-modal'].open();" title="Przenieść ten temat do innej kategorii forum" href="javascript:">
                <i class="fa fa-arrow-circle-right fa-fw"></i>

                Przenieś wątek
              </a>
            </li>
          {% endif %}
        </ul>

        {% if can('move', forum) %}
          <vue-modal ref="forum-modal">
            <template v-slot:title>Czy chcesz przenieść?</template>

            <template v-slot:buttons>
              <button @click="$refs['forum-modal'].close()" type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
              <vue-button @click.native="move" :disabled="isProcessing" class="btn btn-danger danger">Tak, przenieś</vue-button>
            </template>

            <p>Czy na pewno chcesz przenieść wątek do innej kategorii?</p>

            <p>
              <select v-model="forumId" class="form-control form-control-sm">
                <option v-for="forum in sortedForums" :key="forum.id" :value="forum.id" v-html="forum.name"></option>
              </select>
            </p>

            <p>
              <vue-select name="reason_id" :options="reasons" :value.sync="reasonId" class="form-control-sm" placeholder="-- wybierz --"></vue-select>
            </p>
          </vue-modal>
        {% endif %}

        {% if can('update', forum) %}
          <vue-modal ref="update-modal">
            <template v-slot:title>Zmień tytuł</template>

            <template v-slot:buttons>
              <button @click="$refs['update-modal'].close()" type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
              <vue-button @click.native="changeTitle" :disabled="isProcessing" class="btn btn-danger danger">Zmień tytuł</vue-button>
            </template>

            <input type="text" name="subject" v-model="topic.subject" @keydown.enter="changeTitle" class="form-control">
          </vue-modal>
        {% endif %}

      </div>
    {% endblock %}

    {% block related %}
      {% if mlt|length > 0 %}
        <section id="box-related" class="box related">
          <h4 class="border-bottom"><i class="far fa-eye fa-fw"></i> Strony pokrewne</h4>

          <div>
            <ul>
              {% for page in mlt %}
                <li>
                  <a href="{{ route('forum.topic', [page.forum.slug, page.id, page.slug]) }}" title="{{ page.subject|raw }}">
                    <strong>{{ page.subject|raw }}</strong>
                    <small>{{ page.last_post_created_at|format_date }}</small>
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </section>
      {% endif %}
    {% endblock %}
  {% endembed %}
{% endblock %}

{% block body %}
  <script>
    var pagination = {{ posts|json_encode|raw }};
    var topic = {{ topic|json_encode|raw }};
    var poll = {{ poll|json_encode|raw }};
    var forum = {{ forum|json_encode|raw }};
    var allForums = {{ all_forums|json_encode|raw }};
    var reasons = {{ reasons|json_encode|raw }};
    var tags = {{ tags.user|json_encode|raw }};
  </script>

  {{ parent() }}
{% endblock %}
