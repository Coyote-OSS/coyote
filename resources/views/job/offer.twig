{% extends 'job.base' %}

{% set page_title = job.title ~ ' ' ~ (job.firm.id and not job.firm.is_agency ? '@ ' ~ job.firm.name) %}

{% block title %}{{ page_title }} :: praca dla programistów {{ parent() }}{% endblock %}

{% block ogtitle %}{{ page_title }}{% endblock %}
{% block description %}{{ excerpt(job.description) }}{% endblock %}
{% block keywords %}{{ keywords(job.description)|join(',') }}{% endblock %}
{% block logo %}{{ job.firm.logo ? logo(job.firm.logo, true) : secure_asset('img/apple-touch.png') }}{% endblock %}

{% set is_author = job.enable_apply and job.user_id == auth_user().id %}

{% block head %}
  {{ parent() }}

  <script src="//maps.googleapis.com/maps/api/js?key={{ config('services.google-maps.key') }}&sensor=false"></script>
{% endblock %}

{% block container %}
  <div class="row mt-3">
    <div class="col-12">
      <div id="js-flags">
        <vue-flag v-for="flag in flags" :key="flag.id" :flag="flag"></vue-flag>
      </div>

      {% if job.is_expired %}
        <div class="alert alert-warning">
          To ogłoszenie wygasło w dniu <strong>{{ job.deadline_at|format_date }}</strong>.
        </div>
      {% endif %}

      {% if is_author %}
        <ul class="nav nav-pills mb-3">
          <li class="nav-item">
            <a class="nav-link active" href="#offer" role="tab" data-bs-toggle="tab">
              Ogłoszenie
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#applications" role="tab" data-bs-toggle="tab">
              Kandydaci
              <small>({{ applications|length }})</small>
            </a>
          </li>
        </ul>
      {% endif %}

      <div class="job-navlinks p-1">
        <span class="text-primary">
          {{ icon('jobOfferBack') }}
        </span>
        <a href="{{ previous_url ?: route('job.home') }}">
          Powrót do listy ofert
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-9">
      {% if payment and not session_has('success') %}
        <div class="alert alert-warning">
          <h4>
            {{ icon('jobOfferPaymentRequired') }}
            Oczekiwanie na płatność.
          </h4>
          <p>
            Ogłoszenie jest już w naszej bazie. Nie możemy jednak rozpocząć wyświetlania oferty, dopóki nie uregulujesz płatności.
          </p>
          <a href="{{ route('job.payment', [payment.id]) }}" class="mt-2">
            Przejdź do płatności
          </a>
        </div>
      {% endif %}

      <div class="tab-content">
        <div id="offer" class="tab-pane active neon-tile neon-rounded py-2 pb-4 mb-3">
          <div class="px-2" style="margin-bottom:64px;">
            <div class="section-banner px-4" style="height:80px; padding-top:80px;">
              <div class="d-flex justify-content-between align-items-center" style="height:0;">
                <div>
                  {% if job.firm.logo.filename %}
                    <a title="Zobacz wszystkie oferty {{ job.firm.name }}" href="{{ route('job.firm', [job.firm.slug]) }}">
                      <img class="size-75 rounded-full"
                           src="{{ logo(job.firm.logo) }}"
                           alt="{{ job.firm.name }}">
                    </a>
                  {% endif %}
                </div>
                <div>
                  {% if auth_check() %}
                    <span
                        class="btn btn-secondary me-1"
                        data-url="{{ route('job.offer', [job.id, job.slug], false) }}"
                        data-metadata="{{ {"Coyote\\Job": job.id}|encrypt }}">
                      {{ icon('jobOfferReport') }}
                    </span>
                  {% endif %}
                  {% if not job.is_expired %}
                    {% if job.enable_apply %}
                      <a class="btn btn-primary"
                         rel="nofollow"
                         href="{{ not preview ? route('job.application', [job.id]) : 'javascript:' }}"
                          {{ is_applied ? 'title="Już aplikowałeś na tę ofertę pracy" disabled' }}>
                        Aplikuj
                      </a>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          <div id="job-offer" class="card-body px-4">
            <section>
              <h1>
                {{ link_to_route('job.offer', job.title, [job.id|default(0), job.slug]) }}
              </h1>
              {% if job.firm.name %}
                <a class="employer text-muted" 
                   title="Zobacz oferty pracy z firmy {{ job.firm.name }}" 
                   href="{{ route('job.firm', [job.firm.slug]) }}">
                  {{ job.firm.name }}
                </a>
              {% endif %}

              {% if job.salary_from or job.salary_to %}
                <p class="salary float-end">
                  {% include 'job.partials.salary' with {net_label: true, rate_label: true} %}
                </p>
              {% endif %}

              {% if job.locations[0].city is not empty %}
                <ul class="metadata list-inline location">
                  <li class="list-inline-item" title="Lokalizacja">
                    {{ icon('jobOfferLocation') }}
                    {% include 'job.partials.location' with {'locations': job.locations} %}
                  </li>
                </ul>
              {% endif %}
            </section>

            <ul class="about-items list-group list-group-horizontal row">
              <li class="list-group-item col-sm-6">
                {{ icon('jobOfferContract') }}
                <p>
                  <strong>{{ employment_list[job.employment] }}</strong>
                  <small>Umowa</small>
                </p>
              </li>

              {% if job.seniority %}
                <li class="list-group-item col-sm-6">
                  {{ icon('jobOfferSeniority') }}
                  <p>
                    <strong>{{ seniority_list[job.seniority] }}</strong>
                    <small>Poziom doświadczenia</small>
                  </p>
                </li>
              {% endif %}

              {% if job.firm.employees %}
                <li class="list-group-item col-sm-6">
                  {{ icon('jobOfferCompanyEmployees') }}
                  <p>
                    <strong>{{ employees_list[job.firm.employees] }} pracowników</strong>
                    <small>Rozmiar firmy</small>
                  </p>
                </li>
              {% endif %}

              {% if job.firm.founded %}
                <li class="list-group-item col-sm-6">
                  {{ icon('jobOfferCompanyEstablishmentYear') }}
                  <p>
                    <strong>{{ job.firm.founded }}</strong>
                    <small>Rok założenia firmy</small>
                  </p>
                </li>
              {% endif %}

              {% if job.firm.website %}
                <li class="list-group-item col-sm-6">
                  {{ icon('jobOfferCompanyWebsite') }}
                  <p>
                    <strong><a href="{{ job.firm.website }}">{{ job.firm.website }}</a></strong>
                    <small>WWW</small>
                  </p>
                </li>
              {% endif %}
            </ul>

            {% if job.description %}
              <section>
                <h3 class="mt-3">Opis oferty</h3>

                <div class="text">
                  {{ job.description|raw }}
                </div>
              </section>
            {% endif %}

            {% if job.features %}
              <section>
                <h3 class="mt-3 neon-color-link">
                  Metodologia pracy
                </h3>
                <ul class="features list-group list-group-horizontal row">
                  {% for feature in job.features %}
                    <li class="list-group-item col-12 col-sm-6 {{ feature.pivot.checked ? 'checked' }}">
                      {% if feature.pivot.checked %}
                        {{ icon('jobOfferFeaturePresent') }}
                      {% else %}
                        {{ icon('jobOfferFeatureMissing') }}
                      {% endif %}
                      {{ feature.name }}
                      {% if feature.pivot.getAttribute('value') %}
                        <small class="text-muted"> ― {{ feature.pivot.getAttribute('value') }}</small>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </section>
            {% endif %}

            {% if job.firm.benefits|length %}
              <section>
                <h3 class="mt-3">Oferujemy</h3>

                <ul class="benefits list-group list-group-horizontal row">
                  {% for benefit in job.firm.benefits %}
                    <li class="list-group-item col-12 col-sm-6 checked">
                      {{ icon('jobOfferBenefit') }}
                      {{ benefit.name }}
                    </li>
                  {% endfor %}
                </ul>
              </section>
            {% endif %}

            {% if job.firm.name and (assets|length > 0 or job.firm.youtube_url) %}
              <section>
                <h3 class="mt-3">Praca w {{ job.firm.name }}</h3>

                <div id="gallery">
                  {% for asset in assets %}
                    <a href="{{ asset.url }}" data-toggle="lightbox"><img alt="{{ asset.name }}" src="{{ asset.url }}"></a>
                  {% endfor %}

                  {% if job.firm.youtube_url and assets|length > 0 %}
                    <div class="yt">
                      <div class="embed-responsive embed-responsive-16by9">
                        <iframe class="youtube-player" src="{{ job.firm.youtube_url }}" frameborder="0" allowfullscreen></iframe>
                      </div>
                    </div>
                  {% endif %}
                </div>

                {% if job.firm.youtube_url and not assets|length %}
                  <div class="embed-responsive embed-responsive-16by9">
                    <iframe class="youtube-player" src="{{ job.firm.youtube_url }}" frameborder="0" allowfullscreen></iframe>
                  </div>
                {% endif %}
              </section>
            {% endif %}

            {% if job.firm.name and (job.firm.headline or job.firm.description) %}
              <section>
                <h3 class="mt-3">O {{ job.firm.name }}</h3>

                <div class="text">
                  {% if job.firm.headline %}
                    <blockquote>{{ job.firm.headline }}</blockquote>
                  {% endif %}

                  {{ job.firm.description|raw }}
                </div>
              </section>
            {% endif %}

            {% if job.firm.longitude and job.firm.latitude %}
              <div id="map">
                <vue-map class="h-100" latitude="{{ job.firm.latitude }}" longitude="{{ job.firm.longitude }}">
                  <vue-marker latitude="{{ job.firm.latitude }}" longitude="{{ job.firm.longitude }}"></vue-marker>
                </vue-map>
              </div>
            {% endif %}

            {% if not job.is_expired %}
              {% if not job.enable_apply %}
                <h3 id="apply" class="mt-3">Informacje o rekrutacji</h3>
                <div class="text">
                  {{ job.recruitment|raw }}
                </div>
              {% else %}
                <div id="apply" class="mt-4">
                  <a class="btn btn-primary" rel="nofollow" href="{{ not preview ? route('job.application', [job.id]) : 'javascript:' }}" {{ is_applied ? 'title="Już aplikowałeś na tę ofertę pracy" disabled' }}>
                    Aplikuj na to stanowisko
                  </a>
                </div>
              {% endif %}
            {% endif %}
          </div>
        </div>

        {% if is_author %}
          <div id="applications" class="card tab-pane">
            {% include 'job.partials.applications' %}
          </div>
        {% endif %}
      </div>

      {% include 'job.partials.comments' %}
    </div>

    <aside class="col-md-3">
      <div class="neon-tile neon-rounded p-3 mb-3">
        {% include 'job.partials.sidemenu' %}
      </div>

      {% if can('job-update') %}
        <section id="box-job-firm" class="box">
          <div class="neon-tile neon-rounded p-3 mb-3">
            <ul class="list-unstyled mb-0">
              <li title="Data opublikowania" class="mb-2">
                {{ icon('jobOfferPublishDate') }}
                {{ job.boost_at|format_date }}
              </li>
              <li title="Liczba odsłon" class="counter mb-2">
                {{ icon('jobOfferViews') }}
                {{ declination(job.views, ['odsłona', 'odsłony', 'odsłon']) }}
              </li>
              {% if not job.is_expired %}
                <li title="Oferta traci ważność z dniem {{ job.deadline_at|format_date(false) }}">
                  {{ icon('jobOfferExpiresInDays') }}
                  {{ job.deadline }} dni do końca
                </li>
              {% endif %}
            </ul>
          </div>
        </section>
      {% endif %}
      <section class="box">
        <div class="neon-tile neon-rounded p-3 mb-3">
          {% if tags|length > 0 %}
            <section class="requirements">
              {% for category, tags in tags %}
                <div class="mb-3">
                  {{ category }}
                  <ul class="tag-clouds tag-clouds-md">
                    {% for tag in tags %}
                      <li>
                        <a href="{{ route('job.tag', [tag.name|url_encode]) }}" title="Znajdź oferty zawierające {{ tag.real_name|default(tag.name) }}" class="neon-tag">
                          {{ tag.real_name|default(tag.name) }}
                        </a>
                        {% set tooltip = ['mile widziane', 'średnio zaawansowany', 'zaawansowany'][tag.pivot.priority] %}
                        {% apply spaceless %}
                          <div class="progress-bar-dotted" title="{{ tooltip }}">
                            {% for i in 1..3 %}
                              {% if tag.pivot.priority >= i %}
                                <span class="text-primary">
                                  {{ icon('jobOfferRequirementRanked') }}
                                </span>
                              {% else %}
                                <span>
                                  {{ icon('jobOfferRequirementRank') }}
                                </span>
                              {% endif %}
                            {% endfor %}
                          </div>
                        {% endapply %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            </section>
          {% endif %}
        </div>
      </section>
      {% if mlt|length %}
        <section class="box">
          <div class="neon-tile neon-rounded p-3 card-media">
            {% include 'legacyComponents.jobs' with {'jobs': mlt} %}
          </div>
        </section>
      {% endif %}
    </aside>
  </div>
{% endblock %}

{% block body %}
  <script>
    var comments = {{ comments|json_encode|raw }};
    var flags = {{ flags|json_encode|raw }};
    var job = {{ job|json_encode|raw }};
    var subscriptions = {{ subscriptions|json_encode|raw }};
    var emojis = {{ emojis|json_encode|raw }};
  </script>

  {{ parent() }}

{% endblock %}
